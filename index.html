<!DOCTYPE html>
<html>
    <head>
        <title>Web3 Testbed</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" />
    </head>
    <body>
        
        <div class="container">
            <div id="reports">
                <h2>Reports <small>Alpha 0.0.2</small></h2>
                <ol>
                    <li v-for="report in ethReports">
                        {{ report.longitude }} | {{ report.latitude }}
                    </li>
                </ol>
            </div>
                <hr>
                <div class="container" id="app">
                    

                  <p>
                    <label for="name">Longitude: <label>
                    <input type="text" name="longitude" id="longitude" v-model="this.alongitude">
                  </p>

                  <p>
                    <label for="name">Latitude: <label>
                    <input type="text" name="latitude" id="latitude" v-model="this.alatitude">
                  </p>

                  <p>
                      <button v-on:click="this.manual">Manual Entry</button>
                      <button v-on:click="this.GPS">GPS Entry</button>
                      <button v-on:click="this.register">Register</button>
                  </p>

                </div>
        </div>
        
        <!-- Le Javascript -->
        <script src="https://cdn.jsdelivr.net/npm/web3@0.19.0/dist/web3.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue"></script>
                  
        <!-- Other Custom Javascript -->
        <script src="./js/scripts.js"></script>
        <script src="./js/abi.js"></script>
        
        <script>
            
                    if ("geolocation" in navigator) {
                      /* geolocation is available */
                        navigator.geolocation.getCurrentPosition(function(position) {
                            addReports.x = position.coords.latitude;
                            addReports.y = position.coords.longitude;
                        });
                    }
                    else {
                        addReports.x = null;
                        addReports.y = null;
                    }
            
            
            
            // WEB3 INITIALIZATION
        
          window.addEventListener("load", function() {
                // Checking if Web3 has been injected by the browser (Mist/MetaMask)
                if (typeof web3 !== "undefined") {
                  // Use Mist/MetaMask's provider
                  window.web3 = new Web3(web3.currentProvider);
                } else {
                  console.log("No web3? You should consider trying MetaMask!");
                  // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
                  window.web3 = new Web3(
                    new Web3.providers.HttpProvider("https://localhost:8545")
                  );
                }
          })
            
                const contractAddress = "0xe9fba6283e172a67126226a5b7a85146c9a09a21"
                const contract = web3.eth.contract(abiArray).at(contractAddress);
            
                // POPULATE ethReports #reports Vue
                
                let reportEvent = contract.Report({}, {fromBlock: 0, toBlock: 'latest'})
                reportEvent.get((error, logs) => {
                    
                  // Logs Retrieved
                    
                  for (i=0;i<=logs.length;i++){
                      
                      var lat = logs[i].args._latitude.c
                      var long = logs[i].args._longitude.c
                      reports.ethReports.push({latitude: lat, longitude: long})
                      
                  }
                })
            
      
            // VUE + WEB3 APPLICATION
            
      
            var reports = new Vue({
                el: '#reports',
                data: {
                    ethReports: [
                        // To be populated by event logs
                    ]   
                }
            })

            
            var addReports = new Vue({
                el: '#app',
                data: {
                    alongitude:null,
                    alatitude:null,
                    x: 0,
                    y: 0,
                    streets: []
                },
                methods: {
                 GPS: function(){
                     if(addReports.x != null && addReports.y != null) {
                         // reports.ethReports.push({longitude: addReports.x, latitude: addReports.y});
                         contract.inputReport(addReports.x, addReports.y, {value: 0, gas: 90000}, function(err, result){
                                 if(!err){
                                     console.log(result)
                                 }
                             });
                     }
                 },
                 manual: function(){
                     if(alongitude != null && alatitude != null){
                     // reports.ethReports.push({longitude: alongitude, latitude: alatitude});
                         contract.inputReport(alongitude, alatitude, {value: 0, gas: 90000}, function(err, result){
                             if(!err){
                                 console.log(result)
                             }
                         });
                     }
                 },
                 register: function(){
                     if(contract.isRegistered(web3.eth.accounts[0])){
                         contract.register(alongitude, alatitude, {value: 0, gas: 90000}, function(err, result){
                             if(!err){
                                 console.log(result)
                             }
                         });
                     }
                     else{
                         console.log("already registered")
                     }
                 }
                }
            })
              
        </script>
    </body>
</html>
